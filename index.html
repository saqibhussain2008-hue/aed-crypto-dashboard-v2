<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saqib Hussain Crypto Tracker</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <script src="[https://unpkg.com/lucide@latest](https://unpkg.com/lucide@latest)"></script>
    <script src="[https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js](https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js)"></script>
    <style>
        @import url('[https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap)');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate 900 - Deep background */
            color: #E2E8F0; /* Slate 200 - Default text */
        }
        .card {
            background-color: #1E293B; /* Slate 800 - Card background */
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.3); /* Subtle Fuchsia Glow */
            transition: transform 0.2s, background-color 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            background-color: #334155; /* Slate 700 on hover */
        }
        /* Neon Accents (Fuchsia/Purple) */
        .neon-accent { color: #A855F7; } /* Fuchsia 500 */
        
        /* Signal Colors */
        .signal-buy { background-color: #10b981; color: white; } /* Emerald 500 */
        .signal-sell { background-color: #ef4444; color: white; } /* Red 500 */
        .signal-hold { background-color: #fbbf24; color: black; } /* Amber 400 */
        
        /* P/L Status */
        .status-profit { color: #34D399; } /* Emerald 400 */
        .status-loss { color: #F87171; } /* Red 400 */
        .status-zero { color: #94A3B8; } /* Slate 400 */
        
        .icon-lg { width: 24px; height: 24px; }
        .price-up { color: #34D399; }
        .price-down { color: #F87171; }
        /* MACD Histogram colors */
        .macd-hist-up { color: #34D399; }
        .macd-hist-down { color: #F87171; }
        
        /* SL/TP Alerts - Adjusted for dark mode contrast */
        .alert-sl { background-color: #450A0A; border: 1px solid #B91C1C; color: #FCA5A5; } /* Dark Red */
        .alert-tp { background-color: #064E3B; border: 1px solid #10B981; color: #A7F3D0; } /* Dark Green */
        
        /* Rebalance Suggestions */
        .rebalance-buy { background-color: #064E3B; border: 1px solid #10B981; color: #A7F3D0; }
        .rebalance-sell { background-color: #450A0A; border: 1px solid #B91C1C; color: #FCA5A5; }
    </style>
    <script type="module">
        import { initializeApp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js)";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js)";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, deleteField, Timestamp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";
        import { setLogLevel } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js)";
        
        // Expose Firebase objects globally for use in the main script block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, deleteField, Timestamp,
            setLogLevel
        };
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="owner-login-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center">
        <div class="card p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold neon-accent mb-4">Owner Sign In Required</h3>
            <p class="text-slate-400 mb-4">You are viewing as a guest. Please sign in with the owner credentials to manage the portfolio (add/edit/delete entries).</p>
            <form id="owner-login-form" class="space-y-4">
                <div>
                    <label for="owner-email" class="block text-sm font-medium text-slate-400">Email</label>
                    <input type="email" id="owner-email" required class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="owner@example.com">
                </div>
                <div>
                    <label for="owner-password" class="block text-sm font-medium text-slate-400">Password</label>
                    <input type="password" id="owner-password" required class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-slate-900 bg-fuchsia-400 hover:bg-fuchsia-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-fuchsia-500 focus:ring-offset-slate-900 transition duration-150 ease-in-out">
                    Sign In as Owner
                </button>
                <p id="login-status-message" class="text-center text-sm mt-2 text-red-400"></p>
            </form>
        </div>
    </div>


    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-slate-100 flex items-center justify-center">
            <i data-lucide="line-chart" class="icon-lg mr-3 neon-accent"></i>
            Saqib Hussain Crypto Tracker
        </h1>
        <p class="text-slate-400 mt-2">Real-time prices, **High-Conviction** signals, and portfolio tracker.</p>
    </header>

    <main class="max-w-7xl mx-auto space-y-8">

        <div id="disclaimer" class="p-4 bg-yellow-900/40 border-l-4 border-yellow-500 text-yellow-300 rounded-md shadow-md">
            <h3 class="font-bold text-lg mb-1">⚠️ Financial Disclaimer (5-Minute Interval)</h3>
            <p class="text-sm">Signals are now based on **5-minute price data** for more stability. This dashboard is for **educational and simulation purposes only**; any real investment decisions are made at your own risk. Please use the "My Thesis & Plan" section to document your strategy.</p>
        </div>

        <section class="card p-6">
            <h2 class="text-2xl font-semibold text-slate-100 mb-4">Market Data & Signals (USDT/AED - 5 Min Interval)</h2>
            <div id="market-data-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 xl:grid-cols-6 gap-4">
                <p class="col-span-full text-center text-slate-400 py-4">Loading real-time data...</p>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="card p-6 lg:col-span-2">
                <h2 class="text-2xl font-semibold text-slate-100 mb-4 flex items-center">
                    <i data-lucide="wallet" class="mr-2 neon-accent"></i>
                    My Portfolio Summary
                </h2>
                <div id="portfolio-summary" class="grid grid-cols-3 gap-4 border-b border-slate-700 pb-4 mb-4">
                    <div class="p-3 bg-slate-700 rounded-lg">
                        <p class="text-sm text-slate-400">Total Invested (AED)</p>
                        <p id="total-invested-aed" class="text-xl font-bold text-slate-100">0.00</p>
                    </div>
                    <div class="p-3 bg-slate-700 rounded-lg">
                        <p class="text-sm text-slate-400">Total Value (AED)</p>
                        <p id="total-value-aed" class="text-xl font-bold text-slate-100">0.00</p>
                    </div>
                    <div class="p-3 bg-slate-700 rounded-lg">
                        <p class="text-sm text-slate-400">Total Value (USD)</p>
                        <p id="total-value-usd" class="text-xl font-bold text-slate-100">0.00</p>
                    </div>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-slate-400">Overall Profit / Loss (AED)</p>
                    <p id="overall-pnl" class="text-3xl font-extrabold status-zero">0.00 (0.00%)</p>
                </div>

                <div class="mt-6 pt-4 border-t border-slate-700">
                    <h3 class="text-xl font-medium text-slate-100 mb-3 flex items-center">
                        <i data-lucide="scale" class="w-5 h-5 mr-2 neon-accent"></i>
                        Rebalancing Recommendations
                    </h3>
                    <div id="rebalance-suggestions" class="space-y-2">
                         <p class="text-center text-slate-400 py-2 text-sm">Waiting for portfolio data to calculate targets...</p>
                    </div>
                </div>
                
                <h3 class="text-xl font-medium text-slate-100 mb-3 border-t border-slate-700 pt-4 mt-6">Current Holdings</h3>
                <div id="holdings-list" class="space-y-2">
                    <p class="text-center text-slate-400 py-4">No investments added yet.</p>
                </div>
            </div>

            <div id="investment-card" class="card p-6">
                <h2 class="text-2xl font-semibold text-slate-100 mb-4 flex items-center">
                    <i data-lucide="plus-circle" class="mr-2 neon-accent"></i>
                    Add Investment
                </h2>
                <div id="owner-access-message" class="space-y-4">
                    <p class="text-center text-sm text-red-400">
                        Portfolio management is restricted.
                    </p>
                    <button id="sign-in-owner" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-slate-900 bg-fuchsia-400 hover:bg-fuchsia-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-fuchsia-500 focus:ring-offset-slate-900 transition duration-150 ease-in-out">
                        Sign In as Owner
                    </button>
                </div>
                
                <form id="investment-form" class="space-y-4 hidden">
                    <div>
                        <label for="currency" class="block text-sm font-medium text-slate-400">Currency</label>
                        <select id="currency" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-600 bg-slate-700 text-slate-200 focus:outline-none focus:ring-fuchsia-500 focus:border-fuchsia-500 sm:text-sm rounded-md shadow-sm">
                            <option value="">Select Coin</option>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="CAKE">PancakeSwap (CAKE)</option>
                            <option value="SOL">Solana (SOL)</option>
                            <option value="BNB">Binance Coin (BNB)</option>
                            <option value="APRB">APRIORIO (APRB)</option>
                        </select>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-slate-400">Quantity Purchased</label>
                        <input type="number" step="any" id="quantity" required class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="e.g., 0.5">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-slate-400">Purchase Price (AED)</label>
                        <input type="number" step="any" id="price" required class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="e.g., 100000.00">
                    </div>

                    <div class="border-t border-slate-700 pt-4 space-y-3">
                        <p class="text-sm font-semibold text-slate-200">Risk Management (Optional)</p>
                        <div>
                            <label for="takeProfit" class="block text-xs font-medium text-slate-400">Take-Profit (TP) Price (AED)</label>
                            <input type="number" step="any" id="takeProfit" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="e.g., 120000.00">
                        </div>
                        <div>
                            <label for="stopLoss" class="block text-xs font-medium text-slate-400">Stop-Loss (SL) Price (AED)</label>
                            <input type="number" step="any" id="stopLoss" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-slate-200 shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="e.g., 90000.00">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-slate-900 bg-fuchsia-400 hover:bg-fuchsia-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-fuchsia-500 focus:ring-offset-slate-900 transition duration-150 ease-in-out">
                        Add Investment
                    </button>
                    <p id="form-status" class="text-center text-sm mt-2"></p>
                </form>
            </div>
        </section>

    </main>
    
    <footer class="mt-12 text-center text-slate-600 text-sm">
        <p>Data provided by Binance Data API. Currency conversion based on fixed 1 USDT = 3.6725 AED rate. Signals are for educational purposes.</p>
    </footer>

    <script type="module">
        // --- 1. CONFIGURATION FOR GITHUB PAGES (REQUIRED FIX) ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAI3Pl5vgTJmeAC7cZFcBH2DAmkDWuBjEc",
            authDomain: "crypto-dashboard-58a99.firebaseapp.com",
            projectId: "crypto-dashboard-58a99",
            storageBucket: "crypto-dashboard-58a99.firebasestorage.app",
            messagingSenderId: "1033795648349",
            appId: "1:1033795648349:web:c965ff343a06a2cee3c6b4",
            measurementId: "G-QS72PY0FND"
        };
        // --- 2. OWNER CONFIGURATION ---
        const OWNER_ID = 'OpICNqYsGaMNcRwQ6L3C9fx5wXz1'; 
        // -------------------------------------------------------------
        
        // Configuration
        const AED_RATE = 3.6725;
        const CRYPTO_SYMBOLS = ["BTC", "ETH", "CAKE", "SOL", "BNB", "APRB"];
        const BINANCE_BASE_URL = "[https://data-api.binance.vision/api/v3](https://data-api.binance.vision/api/v3)"; // Switched to data-api for reliability
        const UPDATE_INTERVAL_MS = 15000; // 15 seconds update frequency (for UI update)
        const REBALANCE_THRESHOLD_PERCENT = 10; // Rebalance if weight drifts +/- 10%

        // Store Chart instances globally to destroy/re-render
        let charts = {};

        // --- Firebase State Variables (Top of Scope) ---
        let db, auth, userId = null;
        let isAuthReady = false;
        let livePrices = {};
        let investments = [];
        let userTheses = {};
        let signalData = {}; // Stores the latest signal (Buy/Sell/Hold) for rebalancing logic
        
        const firebaseConfig = FIREBASE_CONFIG; 


        // UI elements
        const marketDataContainer = document.getElementById('market-data-container');
        const holdingsList = document.getElementById('holdings-list');
        const overallPnlEl = document.getElementById('overall-pnl');
        const totalInvestedAedEl = document.getElementById('total-invested-aed');
        const totalValueAedEl = document.getElementById('total-value-aed');
        const totalValueUsdEl = document.getElementById('total-value-usd');
        const formStatusEl = document.getElementById('form-status');
        const investmentForm = document.getElementById('investment-form');
        const investmentCard = document.getElementById('investment-card');
        const ownerAccessMessage = document.getElementById('owner-access-message');
        const signInOwnerBtn = document.getElementById('sign-in-owner');
        const ownerLoginModal = document.getElementById('owner-login-modal');
        const ownerLoginForm = document.getElementById('owner-login-form');
        const loginStatusMessage = document.getElementById('login-status-message');
        const rebalanceSuggestionsEl = document.getElementById('rebalance-suggestions');
        
        // Utility for exponential backoff retry logic
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed: ${error.message}`); 
                    if (i === maxRetries - 1) throw error; 
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- Core Application Functions (Defined early for hoisting safety) ---
        
        function getClosingPrices(klines) {
            return klines.map(kline => parseFloat(kline[4]));
        }

        function calculateSMAHistory(prices, period) {
            const smaValues = [];
            for (let i = 0; i < prices.length; i++) {
                if (i < period - 1) {
                    smaValues.push(NaN); 
                } else {
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += prices[i - j];
                    }
                    smaValues.push(sum / period);
                }
            }
            const latestSMA = smaValues[smaValues.length - 1];
            return { history: smaValues, latest: latestSMA };
        }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return null; 

            let changes = [];
            for (let i = 1; i < prices.length; i++) {
                changes.push(prices[i] - prices[i - 1]);
            }
            
            // Calculate initial average gain/loss over the first 'period'
            let sumGain = 0;
            let sumLoss = 0;
            for (let i = 0; i < period; i++) {
                sumGain += Math.max(0, changes[i]);
                sumLoss += Math.max(0, -changes[i]);
            }

            let avgGain = sumGain / period;
            let avgLoss = sumLoss / period;
            
            // Smoothed RSI calculation for the remaining data points
            for (let i = period; i < changes.length; i++) {
                avgGain = (avgGain * (period - 1) + Math.max(0, changes[i])) / period;
                avgLoss = (avgLoss * (period - 1) + Math.max(0, -changes[i])) / period;
            }

            if (avgLoss === 0 && avgGain > 0) return 100;
            if (avgGain === 0 && avgLoss === 0) return 50;

            const RS = avgGain / avgLoss;
            const RSI = 100 - (100 / (1 + RS));
            return RSI;
        }
        
        function calculateEMA(prices, period) {
            if (prices.length < period) return null;
            const multiplier = 2 / (period + 1);
            
            let emaValue = 0;
            for (let i = 0; i < period; i++) {
                emaValue += prices[i];
            }
            emaValue /= period;

            for (let i = period; i < prices.length; i++) {
                emaValue = (prices[i] - emaValue) * multiplier + emaValue;
            }
            return emaValue; 
        }

        function calculateMACD(prices) {
            const fastPeriod = 12; 
            const slowPeriod = 26; 
            const signalPeriod = 9; 
            
            if (prices.length < slowPeriod) return null; 

            let macdLineHistory = [];
            let currentFastEMA = calculateEMA(prices.slice(0, slowPeriod), fastPeriod);
            let currentSlowEMA = calculateEMA(prices.slice(0, slowPeriod), slowPeriod);
            
            if (currentFastEMA === null || currentSlowEMA === null) return null;

            macdLineHistory.push(currentFastEMA - currentSlowEMA);

            const fastMultiplier = 2 / (fastPeriod + 1);
            const slowMultiplier = 2 / (slowPeriod + 1);

            for (let i = slowPeriod; i < prices.length; i++) {
                currentFastEMA = (prices[i] - currentFastEMA) * fastMultiplier + currentFastEMA;
                currentSlowEMA = (prices[i] - currentSlowEMA) * slowMultiplier + currentSlowEMA;
                macdLineHistory.push(currentFastEMA - currentSlowEMA);
            }
            
            if (macdLineHistory.length < signalPeriod) {
                 return { macdLine: macdLineHistory.pop() || null, signalLine: null, histogram: null };
            }
            
            // Calculate Signal Line EMA
            let signalLine = calculateEMA(macdLineHistory, signalPeriod);
            
            // Re-calculate the final signal line accurately using the full history
            let finalSignalLine = 0;
            for (let i = 0; i < signalPeriod; i++) {
                finalSignalLine += macdLineHistory[i];
            }
            finalSignalLine /= signalPeriod;
            
            const signalMultiplier = 2 / (signalPeriod + 1);
            for (let i = signalPeriod; i < macdLineHistory.length; i++) {
                 finalSignalLine = (macdLineHistory[i] - finalSignalLine) * signalMultiplier + finalSignalLine;
            }
            signalLine = finalSignalLine;
            
            const latestMacdLine = macdLineHistory[macdLineHistory.length - 1];
            const histogram = latestMacdLine - signalLine;

            return { macdLine: latestMacdLine, signalLine, histogram };
        }

        function generateSignal(symbol, price, klines) {
            const closingPrices = getClosingPrices(klines);
            const ema12 = calculateEMA(closingPrices, 12);
            const ema26 = calculateEMA(closingPrices, 26);
            const rsi = calculateRSI(closingPrices, 14);
            const macdData = calculateMACD(closingPrices);
            
            let signal = 'HOLD';
            let strategy = 'Waiting for confirmation.';
            let icon = 'pause';
            let strength = '';

            if (rsi === null || ema12 === null || ema26 === null || macdData.signalLine === null) { 
                return { signal: 'HOLD', strategy: 'Gathering data.', icon: 'pause', rsi: 'N/A', macd: 'N/A', signalLine: 'N/A', histogram: 'N/A' };
            }
            
            const isMacdBullish = macdData.macdLine > macdData.signalLine;
            const isMacdBearish = macdData.macdLine < macdData.signalLine;
            const isRSIHealthyForBuy = rsi < 65;
            const isRSIHealthyForSell = rsi > 35;
            const isGoldenCross = ema12 > ema26;
            const isDeathCross = ema12 < ema26;

            if (isMacdBullish && isGoldenCross && isRSIHealthyForBuy) {
                signal = 'BUY';
                icon = 'zap'; 
                strategy = 'MACD & Golden Cross alignment.';
                strength = ' (High Conviction)';
            } else if (isMacdBearish && isDeathCross && isRSIHealthyForSell) {
                signal = 'SELL';
                icon = 'alert-triangle'; 
                strategy = 'MACD & Death Cross alignment.';
                strength = ' (High Conviction)';
            } else if (isMacdBullish) {
                signal = 'HOLD'; 
                icon = 'trending-up';
                strategy = 'MACD Bullish Crossover (Momentum shift).';
                strength = ' (Mid Conviction)';
            } else if (isMacdBearish) {
                signal = 'HOLD'; 
                icon = 'trending-down';
                strategy = 'MACD Bearish Crossover (Momentum shift).';
                strength = ' (Mid Conviction)';
            } else {
                signal = 'HOLD';
                icon = 'pause';
                strategy = 'Consolidation/Low Momentum.';
            }

            return { 
                signal, 
                strategy: strategy + strength, 
                icon, 
                rsi: rsi.toFixed(2),
                macd: macdData.macdLine !== null ? macdData.macdLine.toFixed(4) : 'N/A',
                signalLine: macdData.signalLine !== null ? macdData.signalLine.toFixed(4) : 'N/A',
                histogram: macdData.histogram !== null ? macdData.histogram.toFixed(4) : 'N/A'
            };
        }
        
        function renderChart(symbol, klines) {
            const closingPrices = getClosingPrices(klines);
            const sma12Data = calculateSMAHistory(closingPrices, 12);
            const sma26Data = calculateSMAHistory(closingPrices, 26);
            
            const ctx = document.getElementById(`chart-${symbol}`);
            if (!ctx) return;
            
            if (charts[symbol]) {
                charts[symbol].destroy();
            }

            const labels = klines.map((_, index) => index);
            
            const chartData = closingPrices.map(priceUSD => priceUSD * AED_RATE);
            const sma12ChartData = sma12Data.history.map(priceUSD => isNaN(priceUSD) ? NaN : priceUSD * AED_RATE);
            const sma26ChartData = sma26Data.history.map(priceUSD => isNaN(priceUSD) ? NaN : priceUSD * AED_RATE);

            charts[symbol] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Price (AED)',
                            data: chartData,
                            borderColor: '#A855F7', // Fuchsia 500 Accent
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            pointRadius: 0,
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'SMA 12',
                            data: sma12ChartData,
                            borderColor: '#34D399', // Emerald 400 (Faster MA)
                            pointRadius: 0,
                            borderWidth: 1,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'SMA 26',
                            data: sma26ChartData,
                            borderColor: '#F87171', // Red 400 (Slower MA)
                            pointRadius: 0,
                            borderWidth: 1,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { 
                            display: false,
                            beginAtZero: false,
                            suggestedMin: Math.min(...chartData.filter(v => !isNaN(v))) * 0.99,
                            suggestedMax: Math.max(...chartData.filter(v => !isNaN(v))) * 1.01,
                        }
                    }
                }
            });
        }
        
        function calculateRebalanceSuggestions(totalValueAED) {
            const suggestions = [];
            const investedCoins = investments.map(i => i.currency);
            
            // 1. Calculate current weights
            const weights = {};
            const totalInvestedWeight = investedCoins.length;
            
            if (totalInvestedWeight === 0 || totalValueAED === 0) {
                rebalanceSuggestionsEl.innerHTML = '<p class="text-center text-slate-400 py-2 text-sm">No investments to analyze.</p>';
                return;
            }

            // Calculate current value and total value for each coin
            const currentCoinValues = {};
            investedCoins.forEach(currency => {
                currentCoinValues[currency] = 0;
            });

            investments.forEach(item => {
                const livePriceAED = livePrices[item.currency] || 0;
                currentCoinValues[item.currency] += item.quantity * livePriceAED;
            });

            // Calculate target and drift
            const targetWeightPercent = 100 / totalInvestedWeight;
            
            for (const currency of investedCoins) {
                const currentValue = currentCoinValues[currency];
                const currentWeightPercent = (currentValue / totalValueAED) * 100;
                const driftPercent = currentWeightPercent - targetWeightPercent;
                const signal = signalData[currency] || 'HOLD';
                
                const driftThreshold = Math.abs(driftPercent) > REBALANCE_THRESHOLD_PERCENT;

                if (driftThreshold) {
                    let requiredChangeAED = 0;
                    let action = 'HOLD';
                    let reason = '';
                    
                    const targetValue = totalValueAED * (targetWeightPercent / 100);
                    requiredChangeAED = Math.abs(currentValue - targetValue);
                    
                    if (driftPercent > 0) { // Overweight (Need to Sell)
                        reason = `Overweight (${currentWeightPercent.toFixed(1)}% vs ${targetWeightPercent.toFixed(1)}% Target)`;
                        if (signal === 'SELL') {
                            action = 'SELL';
                            reason += ' - Aligned with SELL signal.';
                        } else if (signal === 'BUY') {
                            action = 'HOLD';
                            reason += ' - CONFLICT: Ignoring SELL (Momentum is BUY).';
                        }
                    } else if (driftPercent < 0) { // Underweight (Need to Buy)
                        reason = `Underweight (${currentWeightPercent.toFixed(1)}% vs ${targetWeightPercent.toFixed(1)}% Target)`;
                        if (signal === 'BUY') {
                            action = 'BUY';
                            reason += ' - Aligned with BUY signal.';
                        } else if (signal === 'SELL') {
                            action = 'HOLD';
                            reason += ' - CONFLICT: Ignoring BUY (Momentum is SELL).';
                        }
                    }

                    if (action !== 'HOLD') {
                        suggestions.push({
                            currency,
                            action,
                            amountAED: requiredChangeAED,
                            reason
                        });
                    }
                }
            }

            if (suggestions.length === 0) {
                rebalanceSuggestionsEl.innerHTML = '<p class="text-center text-slate-400 py-2 text-sm">Portfolio is balanced or signals conflict.</p>';
            } else {
                rebalanceSuggestionsEl.innerHTML = suggestions.map(s => {
                    const colorClass = s.action === 'BUY' ? 'rebalance-buy' : 'rebalance-sell';
                    const icon = s.action === 'BUY' ? 'trending-up' : 'trending-down';
                    return `
                        <div class="p-3 rounded-lg ${colorClass} flex justify-between items-center text-sm font-medium">
                            <span class="flex items-center">
                                <i data-lucide="${icon}" class="w-4 h-4 mr-2"></i>
                                ${s.action} ${s.amountAED.toFixed(2)} AED worth of ${s.currency}
                            </span>
                            <span class="text-xs text-slate-200 ml-2">(${s.reason})</span>
                        </div>
                    `;
                }).join('');
            }
            window.lucide.createIcons();
        }

        async function fetchRealTimeData() {
            console.log("Fetching market data...");
            // Ensure container is cleared and populated only if fetching is successful
            
            const symbols = CRYPTO_SYMBOLS.map(s => s + 'USDT');
            
            try {
                // 1. Fetch 24hr Ticker Data (for current price and % change)
                const tickerUrl = `${BINANCE_BASE_URL}/ticker/24hr?symbols=["${symbols.join('","')}"]`;
                const tickerData = await fetchWithRetry(tickerUrl);

                // 2. Fetch Kline Data for all symbols (for MA/RSI/MACD calculation and Charting) 
                const klinePromises = symbols.map(symbol => {
                    const klineUrl = `${BINANCE_BASE_URL}/klines?symbol=${symbol}&interval=5m&limit=40`;
                    return fetchWithRetry(klineUrl).catch(e => {
                        console.error(`Failed to fetch klines for ${symbol}:`, e);
                        return []; // Return empty array on failure
                    });
                });
                const klinesResults = await Promise.all(klinePromises);
                const klineMap = new Map();
                symbols.forEach((symbol, index) => {
                    klineMap.set(symbol.replace('USDT', ''), klinesResults[index]);
                });

                marketDataContainer.innerHTML = '';
                const newPrices = {};
                const newSignals = {};
                
                tickerData.forEach(item => {
                    const symbol = item.symbol.replace('USDT', '');
                    const currentPriceUSD = parseFloat(item.lastPrice);
                    const currentPriceAED = currentPriceUSD * AED_RATE;
                    const priceChangePercent = parseFloat(item.priceChangePercent);
                    const klines = klineMap.get(symbol);
                    
                    newPrices[symbol] = currentPriceAED;
                    
                    let signalInfo = { signal: 'HOLD', strategy: 'N/A', icon: 'pause', rsi: 'N/A', macd: 'N/A', signalLine: 'N/A', histogram: 'N/A' };
                    
                    if (klines && klines.length > 0) {
                        signalInfo = generateSignal(symbol, currentPriceUSD, klines);
                    }
                    
                    newSignals[symbol] = signalInfo.signal; // Store signal for rebalancing
                    
                    const colorClass = signalInfo.signal === 'BUY' ? 'signal-buy' : 
                                       signalInfo.signal === 'SELL' ? 'signal-sell' : 'signal-hold';
                    
                    const priceClass = priceChangePercent >= 0 ? 'price-up' : 'price-down';
                    const sign = priceChangePercent >= 0 ? '+' : '';
                    
                    const macdHist = signalInfo.histogram !== 'N/A' ? parseFloat(signalInfo.histogram) : 0;
                    const macdHistClass = macdHist >= 0 ? 'macd-hist-up' : 'macd-hist-down';
                    
                    const defaultThesisText = 'Click to set your plan (e.g., Short-term target, Long-term HODL).';
                    const savedThesis = userTheses[symbol] || defaultThesisText;
                    
                    // Owner check for edit access
                    const isOwner = auth.currentUser && auth.currentUser.uid === OWNER_ID;
                    const editableClass = isOwner ? 'bg-slate-700 hover:bg-slate-600' : 'bg-slate-800 cursor-default';


                    const html = `
                        <div class="card p-4 border border-slate-700 flex flex-col justify-between">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-xl font-bold text-slate-100">${symbol}</h3>
                                <div class="px-3 py-1 text-xs font-semibold rounded-full shadow-md ${colorClass} flex items-center">
                                    <i data-lucide="${signalInfo.icon}" class="w-4 h-4 mr-1"></i>
                                    ${signalInfo.signal.toUpperCase()}
                                </div>
                            </div>
                            <div class="flex flex-col mb-3">
                                <p class="text-2xl font-extrabold ${priceClass}">${currentPriceAED.toFixed(2)} <span class="text-sm font-normal text-slate-400">AED</span></p>
                                <p class="text-lg font-medium text-slate-400">$${currentPriceUSD.toFixed(2)} USD</p>
                                <p class="text-sm ${priceClass} mt-1">${sign}${priceChangePercent.toFixed(2)}% (24h)</p>
                            </div>
                            
                            <div class="h-24 w-full mb-3 border border-slate-700 rounded-md p-1 bg-slate-800">
                                <canvas id="chart-${symbol}"></canvas>
                            </div>
                            
                            <div class="space-y-1 text-sm text-slate-400 border-t border-slate-700 pt-2">
                                <p><span class="font-medium text-slate-300">Signal Basis:</span> ${signalInfo.strategy}</p>
                                <p><span class="font-medium text-slate-300">RSI (14):</span> ${signalInfo.rsi}</p>
                                <p class="text-xs">
                                    <span class="font-medium text-slate-300">MACD:</span> ${signalInfo.macd} / ${signalInfo.signalLine} 
                                    <span class="font-bold ${macdHistClass}"> [Hist: ${signalInfo.histogram}]</span>
                                </p>
                            </div>
                            <div class="mt-2 pt-2 border-t border-slate-700">
                                <p class="text-xs font-medium text-slate-500 mb-1">My Thesis & Plan</p>
                                <div contenteditable="${isOwner ? 'true' : 'false'}" 
                                     id="thesis-${symbol}"
                                     class="text-xs text-slate-200 p-2 rounded-md min-h-[40px] focus:outline-none focus:ring-1 focus:ring-fuchsia-500 transition-colors ${editableClass}"
                                     data-symbol="${symbol}"
                                     onblur="window.saveThesis(this)">
                                    ${savedThesis}
                                </div>
                            </div>
                        </div>
                    `;
                    marketDataContainer.innerHTML += html;
                });
                
                // Update global prices and signals, then re-render portfolio
                livePrices = newPrices;
                signalData = newSignals;
                renderPortfolio();

                // RENDER CHARTS
                CRYPTO_SYMBOLS.forEach(symbol => {
                    const klines = klineMap.get(symbol);
                    if (klines && klines.length > 0) {
                        renderChart(symbol, klines);
                    }
                });
                
                window.lucide.createIcons();
                
            } catch (error) {
                console.error("Error fetching market data:", error);
                marketDataContainer.innerHTML = '<p class="col-span-full text-center text-red-500 py-4">Failed to fetch data. Retrying shortly...</p>';
            }
        }

        function renderPortfolio() {
            if (!isAuthReady) return;

            let totalInvestedAED = 0;
            let totalValueAED = 0;

            holdingsList.innerHTML = ''; 

            if (investments.length === 0) {
                rebalanceSuggestionsEl.innerHTML = '<p class="text-center text-slate-400 py-2 text-sm">No investments to analyze.</p>';
                holdingsList.innerHTML = '<p class="text-center text-slate-400 py-4">No investments added yet.</p>';
            }

            investments.forEach(item => {
                const livePriceAED = livePrices[item.currency] || 0;
                const livePriceUSD = livePriceAED / AED_RATE;

                const investedAmount = item.quantity * item.purchasePriceAED;
                const currentValue = item.quantity * livePriceAED;
                const pnl = currentValue - investedAmount;
                const pnlPercent = investedAmount > 0 ? (pnl / investedAmount) * 100 : 0;
                
                totalInvestedAED += investedAmount;
                totalValueAED += currentValue;

                const pnlClass = pnl > 0 ? 'status-profit' : pnl < 0 ? 'status-loss' : 'status-zero';

                // SL/TP Alert Check
                let alertClass = '';
                let alertMessage = '';

                if (item.stopLossAED && livePriceAED <= item.stopLossAED) {
                    alertClass = 'alert-sl';
                    alertMessage = `SL HIT: Price at ${livePriceAED.toFixed(2)} AED`;
                } else if (item.takeProfitAED && livePriceAED >= item.takeProfitAED) {
                    alertClass = 'alert-tp';
                    alertMessage = `TP REACHED: Price at ${livePriceAED.toFixed(2)} AED`;
                }
                
                const isOwner = auth.currentUser && auth.currentUser.uid === OWNER_ID;
                const removeButton = isOwner ? 
                    `<button onclick="window.removeInvestment('${item.id}')" class="ml-4 p-2 text-red-400 hover:text-red-600 rounded-full transition duration-150">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>` : '';


                const holdingHtml = `
                    <div id="holding-${item.id}" class="flex justify-between items-center p-3 bg-slate-700 rounded-lg border border-slate-600 ${alertClass}">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-bold text-slate-100">${item.currency} <span class="text-sm font-normal text-slate-400">(${item.quantity.toFixed(4)})</span></p>
                            ${alertMessage ? `<p class="text-xs font-semibold mt-1">${alertMessage}</p>` : ''}
                            <p class="text-xs text-slate-400 mt-1">
                                Avg. Buy: ${item.purchasePriceAED.toFixed(2)} AED ($${(item.purchasePriceAED/AED_RATE).toFixed(2)})
                            </p>
                            <p class="text-xs text-slate-400">
                                Current: ${livePriceAED.toFixed(2)} AED ($${livePriceUSD.toFixed(2)})
                            </p>
                            ${(item.stopLossAED || item.takeProfitAED) ? 
                                `<p class="text-xs text-slate-500">
                                    SL: ${item.stopLossAED ? item.stopLossAED.toFixed(2) + ' AED' : 'N/A'} | 
                                    TP: ${item.takeProfitAED ? item.takeProfitAED.toFixed(2) + ' AED' : 'N/A'}
                                </p>` : ''}
                        </div>
                        <div class="text-right ml-4">
                            <p class="text-lg font-bold ${pnlClass}">${pnl.toFixed(2)} AED</p>
                            <p class="text-sm ${pnlClass}">(${pnlPercent.toFixed(2)}%)</p>
                        </div>
                        ${removeButton}
                    </div>
                `;
                holdingsList.innerHTML += holdingHtml;
            });

            // Update Summary
            const overallPNLValue = totalValueAED - totalInvestedAED;
            const overallPNLPercent = totalInvestedAED > 0 ? (overallPNLValue / totalInvestedAED) * 100 : 0;
            const overallPNLClass = overallPNLValue > 0 ? 'status-profit' : overallPNLValue < 0 ? 'status-loss' : 'status-zero';

            totalInvestedAedEl.textContent = totalInvestedAED.toFixed(2);
            totalValueAedEl.textContent = totalValueAED.toFixed(2);
            totalValueUsdEl.textContent = (totalValueAED / AED_RATE).toFixed(2);

            overallPnlEl.textContent = `${overallPNLValue.toFixed(2)} AED (${overallPNLPercent.toFixed(2)}%)`;
            overallPnlEl.className = `text-3xl font-extrabold ${overallPNLClass}`;
            
            // Rebalance check (only runs if investments exist)
            calculateRebalanceSuggestions(totalValueAED);

            window.lucide.createIcons();
            
            // Recheck access after portfolio renders
            checkOwnerAccess();
        }

        // --- FIRESTORE OPERATIONS ---

        // Path for portfolio entries: artifacts/{appId}/portfolio_entries
        function getCollectionRef() {
            if (!db) return null;
            const collectionPath = `artifacts/${FIREBASE_CONFIG.appId}/portfolio_entries`;
            return firebase.collection(db, collectionPath);
        }

        // Path for thesis document: artifacts/{appId}/config/thesis_data
        async function getThesisDocRef() {
            if (!db) return null;
            const configDocPath = `artifacts/${FIREBASE_CONFIG.appId}/config`;
            return firebase.doc(db, configDocPath, 'thesis_data');
        }

        async function loadTheses() {
            const docRef = await getThesisDocRef();
            if (!docRef) return;
            
            try {
                const docSnap = await firebase.getDoc(docRef);
                if (docSnap.exists()) {
                    userTheses = docSnap.data().theses || {};
                }
            } catch (e) {
                console.error("Error loading user theses:", e);
            }
        }

        window.saveThesis = async function(element) {
            const isOwner = auth.currentUser && auth.currentUser.uid === OWNER_ID;
            if (!isOwner) return;

            const symbol = element.getAttribute('data-symbol');
            const defaultText = element.getAttribute('data-default-text');
            const content = element.textContent.trim();
            
            if (content === defaultText || content === '') {
                delete userTheses[symbol];
            } else {
                userTheses[symbol] = content;
            }

            const docRef = getThesisDocRef();
            if (!docRef) return;
            
            try {
                await firebase.setDoc(docRef, { theses: userTheses }, { merge: true });
            } catch (e) {
                console.error("Error saving user thesis:", e);
            }
        }

        async function saveInvestment(event) {
            event.preventDefault();
            formStatusEl.textContent = 'Adding investment...';
            
            const currency = document.getElementById('currency').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const price = parseFloat(document.getElementById('price').value);
            const tp = document.getElementById('takeProfit').value ? parseFloat(document.getElementById('takeProfit').value) : null;
            const sl = document.getElementById('stopLoss').value ? parseFloat(document.getElementById('stopLoss').value) : null;

            if (!currency || isNaN(quantity) || isNaN(price) || quantity <= 0 || price <= 0) {
                formStatusEl.textContent = 'Please enter valid quantity and price.';
                return;
            }

            const collectionRef = getCollectionRef();
            if (!collectionRef) return;

            try {
                await firebase.addDoc(collectionRef, {
                    currency: currency,
                    quantity: quantity,
                    purchasePriceAED: price,
                    takeProfitAED: tp,
                    stopLossAED: sl,
                    timestamp: firebase.Timestamp.fromDate(new Date())
                });
                
                formStatusEl.textContent = 'Investment added successfully!';
                investmentForm.reset();
            } catch (e) {
                formStatusEl.textContent = 'Error saving: Check console.';
                console.error("Error adding document: ", e);
            }
        }

        window.removeInvestment = async function(id) {
            const isOwner = auth.currentUser && auth.currentUser.uid === OWNER_ID;
            if (!isOwner) return;

            const docRef = firebase.doc(db, `artifacts/${FIREBASE_CONFIG.appId}/portfolio_entries`, id);
            
            try {
                await firebase.deleteDoc(docRef);
            } catch (e) {
                console.error("Error removing document: ", e);
            }
        }
        
        // --- AUTHENTICATION & INITIALIZATION ---

        function checkOwnerAccess() {
            const isOwner = auth.currentUser && auth.currentUser.uid === OWNER_ID;
            
            if (isOwner) {
                ownerAccessMessage.classList.add('hidden');
                investmentForm.classList.remove('hidden');
                ownerLoginModal.classList.remove('flex'); // Hide modal if they logged in
                ownerLoginModal.classList.add('hidden');
                console.log("Owner Access: GRANTED.");
            } else {
                ownerAccessMessage.classList.remove('hidden');
                investmentForm.classList.add('hidden');
                console.log("Owner Access: DENIED. Viewing as Guest.");
            }
            // FIX: Removed recursive call to renderPortfolio here.
        }

        async function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.projectId) {
                 console.error("Firebase configuration not found. Portfolio tracking will be disabled.");
                 return;
            }
            
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.getFirestore(app);
            auth = firebase.getAuth(app);
            firebase.setLogLevel('error');
            
            // Use anonymous sign-in for all users (guests and owner alike)
            if (!auth.currentUser) {
                await firebase.signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }

            firebase.onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;
                if (user) {
                    userId = user.uid;
                    checkOwnerAccess();
                    
                    // 1. Load Theses
                    await loadTheses();
                    
                    // 2. Start Real-time Portfolio Listener
                    const collectionRef = getCollectionRef();
                    if (collectionRef) {
                        firebase.onSnapshot(collectionRef, (snapshot) => {
                            investments = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            renderPortfolio(); // This is the primary call for rendering portfolio updates
                        }, (error) => {
                            console.error("Portfolio Snapshot Error:", error);
                        });
                    }
                } else {
                    userId = null;
                    isAuthReady = true; 
                    console.log("User logged out or unauthorized.");
                }
                // Check access controls after auth state changes
                checkOwnerAccess(); 
            });
            
            // Start the market data fetch immediately and then set interval
            fetchRealTimeData();
            setInterval(fetchRealTimeData, UPDATE_INTERVAL_MS);
        }
        
        // --- EVENT LISTENERS ---
        
        // Set up the owner sign-in modal/button
        if(signInOwnerBtn) {
             signInOwnerBtn.addEventListener('click', () => {
                ownerLoginModal.classList.remove('hidden');
                ownerLoginModal.classList.add('flex');
                loginStatusMessage.textContent = '';
            });
        }
       
        // Handle owner login submission
        if(ownerLoginForm) {
            ownerLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('owner-email').value;
                const password = document.getElementById('owner-password').value;
                loginStatusMessage.textContent = 'Signing in...';
                
                try {
                    const userCredential = await firebase.signInWithEmailAndPassword(auth, email, password);
                    
                    // Check if the signed-in user is the actual OWNER_ID
                    if (userCredential.user.uid === OWNER_ID) {
                        ownerLoginModal.classList.remove('flex');
                        ownerLoginModal.classList.add('hidden');
                    } else {
                        loginStatusMessage.textContent = 'Login successful, but this user is not the designated owner.';
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error("Owner Login Failed:", error);
                    loginStatusMessage.textContent = 'Error: Invalid email or password.';
                }
            });
        }

        // Initialize App on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

    </script>
</body>
</html>
