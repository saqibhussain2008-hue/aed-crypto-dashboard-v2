<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saqib Hussain Crypto Tracker (Binance Data)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js for Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        /* --- Light Mode Theme --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F1F5F9; /* Slate 100 - Light background */
            color: #1E293B; /* Slate 800 - Default text */
        }
        .card {
            background-color: #FFFFFF; /* White - Card background */
            border-radius: 12px;
            border: 1px solid #E2E8F0; /* Slate 200 - Subtle border */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.04); /* Soft shadow */
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Slightly larger shadow on hover */
        }
        /* Accent Color (Fuchsia - kept for consistency, adjust if needed) */
        .neon-accent { color: #A855F7; } /* Fuchsia 500 */

        /* Input Fields */
        input[type="email"], input[type="password"], input[type="number"], select {
             background-color: #F8FAFC; /* Slate 50 */
             border-color: #CBD5E1; /* Slate 300 */
             color: #1E293B; /* Slate 800 */
        }
        input:focus, select:focus {
             border-color: #A855F7; /* Fuchsia 500 */
             --tw-ring-color: #A855F7; /* Fuchsia 500 ring */
             --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
             --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);
             box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }
         label {
             color: #475569; /* Slate 600 */
         }

        /* Signal Colors (Maintained contrast) */
        .signal-buy { background-color: #10b981; color: white; } /* Emerald 500 */
        .signal-sell { background-color: #ef4444; color: white; } /* Red 500 */
        .signal-hold { background-color: #fbbf24; color: #1F2937; } /* Amber 400 with dark text */

        /* P/L Status */
        .status-profit { color: #10B981; } /* Emerald 500 */
        .status-loss { color: #EF4444; } /* Red 500 */
        .status-zero { color: #64748B; } /* Slate 500 */

        .icon-lg { width: 24px; height: 24px; }
        .price-up { color: #10B981; } /* Emerald 500 */
        .price-down { color: #EF4444; } /* Red 500 */
        /* MACD Histogram colors */
        .macd-hist-up { color: #10B981; }
        .macd-hist-down { color: #EF4444; }

        /* SL/TP Alerts - Adjusted for light mode contrast */
        .alert-sl { background-color: #FEE2E2; border: 1px solid #F87171; color: #991B1B; } /* Light Red */
        .alert-tp { background-color: #D1FAE5; border: 1px solid #34D399; color: #065F46; } /* Light Green */

        /* Rebalance Suggestions - Adjusted for light mode */
        .rebalance-buy { background-color: #D1FAE5; border: 1px solid #34D399; color: #065F46; }
        .rebalance-sell { background-color: #FEE2E2; border: 1px solid #F87171; color: #991B1B; }

        /* General Text Colors */
        h1, h2, h3, .text-slate-100 { color: #1E293B; } /* Slate 800 */
        p, .text-slate-200 { color: #334155; } /* Slate 700 */
        .text-slate-400 { color: #64748B; } /* Slate 500 */
        .text-slate-500 { color: #64748B; } /* Slate 500 */
        .text-slate-600 { color: #475569; } /* Slate 600 */

        /* Specific Overrides */
        #overall-pnl { /* Ensure this stands out */ }
        #portfolio-summary > div { background-color: #F1F5F9; } /* Light background for summary boxes */
        #holdings-list > div { background-color: #F8FAFC; border-color: #E2E8F0;} /* Lighter bg for holding items */
        .indicator-details { border-top-color: #E2E8F0; } /* Lighter border */
        #thesis-${symbol} { background-color: #F1F5F9; border: 1px solid #E2E8F0;} /* Thesis box style */
        .border-slate-700 { border-color: #E2E8F0; } /* Update all dark borders */
        .border-slate-600 { border-color: #CBD5E1; } /* Update medium borders */
        /* Chart background container */
        .h-24.w-full { background-color: #F8FAFC; border-color: #E2E8F0;}

        /* Owner Login Modal Background */
        #owner-login-modal { background-color: rgba(30, 41, 59, 0.75); } /* Keep overlay dark */
        #owner-login-modal .card { background-color: #FFFFFF; } /* Modal card is white */

        /* Disclaimer Background */
        #disclaimer {
             background-color: #FEF3C7; /* Amber 100 */
             border-color: #FBBF24; /* Amber 400 */
             color: #92400E; /* Amber 800 */
        }
        #disclaimer h3 {
             color: #78350F; /* Amber 900 */
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, collection, Timestamp, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword,
            getFirestore, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, collection, Timestamp, deleteField
        };
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Owner Login Modal -->
    <div id="owner-login-modal" class="fixed inset-0 z-50 hidden items-center justify-center"> <!-- Adjusted overlay color in style -->
        <div class="card p-8 w-full max-w-md"> <!-- Card is now white -->
            <h3 class="text-2xl font-bold neon-accent mb-4">Owner Sign In Required</h3>
            <p class="text-slate-500 mb-4">You are viewing as a guest. Please sign in with the owner credentials to manage the portfolio (add/edit/delete entries).</p> <!-- Adjusted text color -->
            <form id="owner-login-form" class="space-y-4">
                <div>
                    <label for="owner-email" class="block text-sm font-medium">Email</label> <!-- Adjusted text color via general rule -->
                    <input type="email" id="owner-email" required class="mt-1 block w-full rounded-md shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500"> <!-- Background/border set in style -->
                </div>
                <div>
                    <label for="owner-password" class="block text-sm font-medium">Password</label> <!-- Adjusted text color via general rule -->
                    <input type="password" id="owner-password" required class="mt-1 block w-full rounded-md shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500"> <!-- Background/border set in style -->
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-fuchsia-600 hover:bg-fuchsia-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-fuchsia-500 transition duration-150 ease-in-out"> <!-- Adjusted button color -->
                    Sign In as Owner
                </button>
                <p id="login-status-message" class="text-center text-sm mt-2 text-red-600"></p> <!-- Adjusted error text color -->
            </form>
        </div>
    </div>

    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold flex items-center justify-center"> <!-- Color set via general rule -->
            <i data-lucide="line-chart" class="icon-lg mr-3 neon-accent"></i>
            Saqib Hussain Crypto Tracker
        </h1>
        <p class="mt-2">Real-time prices, **High-Conviction** signals, and portfolio tracker. (Data: Binance)</p> <!-- Color set via general rule -->
    </header>

    <!-- Main Container -->
    <main class="max-w-7xl mx-auto space-y-8">

        <!-- Disclaimer -->
        <div id="disclaimer" class="p-4 border-l-4 rounded-md shadow-md"> <!-- Colors adjusted in style -->
            <h3 class="font-bold text-lg mb-1"> (5-Minute Interval - Binance Data)</h3>
            <p class="text-sm">Signals are based on 5-minute price data from Binance Spot (USDT pairs)**.</p>
        </div>

        <!-- Real-Time Market Data -->
        <section class="card p-6">
            <h2 class="text-2xl font-semibold mb-4">Market Data & Signals (USDT/AED - 5 Min Interval)</h2> <!-- Color set via general rule -->
            <div id="market-data-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                <!-- Initial Placeholder Cards -->
                <div class="card p-4 border flex flex-col justify-center items-center" id="loading-placeholder"> <!-- Border adjusted in style -->
                       <p class="text-center"> <!-- Color set via general rule -->
                            <i data-lucide="loader-2" class="animate-spin h-8 w-8 mx-auto mb-2"></i>
                            Loading real-time data from Binance...
                       </p>
                </div>
                 <!-- Market data cards will replace the placeholder -->
            </div>
        </section>

        <!-- Portfolio Management and Tracking -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- 1. Portfolio Summary -->
            <div class="card p-6 lg:col-span-2">
                <h2 class="text-2xl font-semibold mb-4 flex items-center"> <!-- Color set via general rule -->
                    <i data-lucide="wallet" class="mr-2 neon-accent"></i>
                    My Portfolio Summary
                </h2>
                <div id="portfolio-summary" class="grid grid-cols-3 gap-4 border-b pb-4 mb-4"> <!-- Background and border adjusted in style -->
                    <div class="p-3 rounded-lg"> <!-- Background adjusted in style -->
                        <p class="text-sm">Total Invested (AED)</p> <!-- Color set via general rule -->
                        <p id="total-invested-aed" class="text-xl font-bold">0.00</p> <!-- Color set via general rule -->
                    </div>
                    <div class="p-3 rounded-lg"> <!-- Background adjusted in style -->
                        <p class="text-sm">Total Value (AED)</p> <!-- Color set via general rule -->
                        <p id="total-value-aed" class="text-xl font-bold">0.00</p> <!-- Color set via general rule -->
                    </div>
                    <div class="p-3 rounded-lg"> <!-- Background adjusted in style -->
                        <p class="text-sm">Total Value (USD)</p> <!-- Color set via general rule -->
                        <p id="total-value-usd" class="text-xl font-bold">0.00</p> <!-- Color set via general rule -->
                    </div>
                </div>
                <div class="mb-4">
                    <p class="text-sm">Overall Profit / Loss (AED)</p> <!-- Color set via general rule -->
                    <p id="overall-pnl" class="text-3xl font-extrabold status-zero">0.00 (0.00%)</p>
                </div>

                <!-- Rebalancing Section -->
                <div class="mt-6 pt-4 border-t"> <!-- Border adjusted in style -->
                    <h3 class="text-xl font-medium mb-3 flex items-center"> <!-- Color set via general rule -->
                        <i data-lucide="scale" class="w-5 h-5 mr-2 neon-accent"></i>
                        Rebalancing Recommendations
                    </h3>
                    <div id="rebalance-suggestions" class="space-y-2">
                         <p class="text-center py-2 text-sm">Waiting for portfolio data to calculate targets...</p> <!-- Color set via general rule -->
                    </div>
                </div>

                <h3 class="text-xl font-medium mb-3 border-t pt-4 mt-6">Current Holdings</h3> <!-- Color & Border adjusted -->
                <div id="holdings-list" class="space-y-2">
                    <p class="text-center py-4">No investments added yet.</p> <!-- Color set via general rule -->
                </div>
            </div>

            <!-- 2. Add Investment Form -->
            <div id="investment-card" class="card p-6">
                <h2 class="text-2xl font-semibold mb-4 flex items-center"> <!-- Color set via general rule -->
                    <i data-lucide="plus-circle" class="mr-2 neon-accent"></i>
                    Add Investment
                </h2>
                <!-- Owner Login Message / Form (Owner only) -->
                <div id="owner-access-message" class="space-y-4">
                    <p class="text-center text-sm text-red-600"> <!-- Adjusted error text color -->
                        Portfolio management is restricted.
                    </p>
                     <button id="sign-in-owner" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-fuchsia-600 hover:bg-fuchsia-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-fuchsia-500 transition duration-150 ease-in-out"> <!-- Adjusted button color -->
                        Sign In as Owner
                    </button>
                </div>

                <form id="investment-form" class="space-y-4 hidden">
                     <div>
                        <label for="currency" class="block text-sm font-medium">Currency</label> <!-- Adjusted text color -->
                        <select id="currency" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base sm:text-sm rounded-md shadow-sm"> <!-- Background/border set in style -->
                            <option value="">Select Coin</option>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="CAKE">PancakeSwap (CAKE)</option>
                            <option value="SOL">Solana (SOL)</option>
                            <option value="BNB">Binance Coin (BNB)</option>
                        </select>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium">Quantity Purchased</label> <!-- Adjusted text color -->
                        <input type="number" step="any" id="quantity" required class="mt-1 block w-full rounded-md shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="e.g., 0.5"> <!-- Background/border set in style -->
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium">Purchase Price (AED)</label> <!-- Adjusted text color -->
                        <input type="number" step="any" id="price" required class="mt-1 block w-full rounded-md shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="e.g., 100000.00"> <!-- Background/border set in style -->
                    </div>

                    <div class="border-t pt-4 space-y-3"> <!-- Border adjusted in style -->
                        <p class="text-sm font-semibold">Risk Management (Optional)</p> <!-- Adjusted text color -->
                        <div>
                            <label for="takeProfit" class="block text-xs font-medium">Take-Profit (TP) Price (AED)</label> <!-- Adjusted text color -->
                            <input type="number" step="any" id="takeProfit" class="mt-1 block w-full rounded-md shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="e.g., 120000.00"> <!-- Background/border set in style -->
                        </div>
                        <div>
                            <label for="stopLoss" class="block text-xs font-medium">Stop-Loss (SL) Price (AED)</label> <!-- Adjusted text color -->
                            <input type="number" step="any" id="stopLoss" class="mt-1 block w-full rounded-md shadow-sm p-2 focus:border-fuchsia-500 focus:ring-fuchsia-500" placeholder="e.g., 90000.00"> <!-- Background/border set in style -->
                        </div>
                    </div>

                     <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-fuchsia-600 hover:bg-fuchsia-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-fuchsia-500 transition duration-150 ease-in-out"> <!-- Adjusted button color -->
                        Add Investment
                    </button>
                    <p id="form-status" class="text-center text-sm mt-2"></p> <!-- Status color will be set dynamically -->
                </form>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="mt-12 text-center text-sm"> <!-- Color adjusted in style -->
        <p>Data provided by Binance Spot API. Currency conversion based on fixed 1 USD = 3.6725 AED rate. Signals are for educational purposes.</p>
    </footer>

    <script type="module">
        // --- 1. CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAI3Pl5vgTJmeAC7cZFcBH2DAmkDWuBjEc",
            authDomain: "crypto-dashboard-58a99.firebaseapp.com",
            projectId: "crypto-dashboard-58a99",
            storageBucket: "crypto-dashboard-58a99.firebasestorage.app",
            messagingSenderId: "1033795648349",
            appId: "1:1033795648349:web:c965ff343a06a2cee3c6b4",
            measurementId: "G-QS72PY0FND"
        };
        const OWNER_ID = 'OpICNqYsGaMNcRwQ6L3C9fx5wXz1';
        // -------------------------------------------------------------

        // --- App Configuration ---
        const AED_RATE = 3.6725;
        const BASE_SYMBOLS = ["BTC", "ETH", "CAKE", "SOL", "BNB"];
        const BINANCE_API_BASE_URL = "https://api.binance.com";
        const UPDATE_INTERVAL_MS = 15000;
        const REBALANCE_THRESHOLD_PERCENT = 10;
        const KLINE_INTERVAL = "5m";
        const KLINE_LIMIT = 40;

        // --- Global State ---
        let charts = {};
        let db, auth, userId = null;
        let isAuthReady = false;
        let livePrices = {};
        let investments = [];
        let userTheses = {};
        let signalData = {};
        const firebaseConfig = FIREBASE_CONFIG;
        const DOM = {};

        function getBinanceSymbol(baseSymbol) { return `${baseSymbol}USDT`; }

        // --- Utility Functions ---
        async function fetchWithRetry(url, options = {}, maxRetries = 3, timeout = 8000) {
            for (let i = 0; i < maxRetries; i++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                options.signal = controller.signal;
                try {
                    const response = await fetch(url, options); clearTimeout(timeoutId);
                    if (!response.ok) {
                        if (response.status === 429 || response.status === 418) {
                            console.warn(`Binance rate limit hit (${response.status}). Retrying...`);
                            const retryAfter = response.headers.get('Retry-After'); let delay = (Math.pow(2, i) + Math.random()) * 5000;
                            if (retryAfter) { const rS = parseInt(retryAfter, 10); if (!isNaN(rS)) { delay = rS * 1000 + 500; console.log(`Retrying after ${rS}s.`); } }
                            await new Promise(resolve => setTimeout(resolve, delay)); continue;
                        } throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) { return await response.json(); }
                    else { const textResponse = await response.text(); throw new Error(`Unexpected content type: ${contentType}. Response: ${textResponse}`); }
                } catch (error) {
                    clearTimeout(timeoutId); const errorType = error.name === 'AbortError' ? '(Timeout)' : '';
                    const errorMessage = `Fetch attempt ${i + 1} for ${url.substring(0, 100)}... failed: ${error.message} ${errorType}`; console.error(errorMessage); // Shorten URL in log
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000; await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        function safeCreateIcons() { if (window.lucide && typeof window.lucide.createIcons === 'function') { try { window.lucide.createIcons(); } catch (e) { console.error("Error calling lucide.createIcons:", e); } } }

       // --- TECHNICAL ANALYSIS FUNCTIONS ---
        function getClosingPrices(binanceKlines) { if (!Array.isArray(binanceKlines)) return []; return binanceKlines.map(kline => parseFloat(kline[4])); }
        function calculateSMAHistory(prices, period) { const smaValues = []; if (!prices || prices.length < period) return { history: [], latest: NaN }; for (let i = 0; i < prices.length; i++) { if (i < period - 1) { smaValues.push(NaN); } else { const startIdx = Math.max(0, i - period + 1); const validSlice = prices.slice(startIdx, i + 1); if (validSlice.length === period) { const sum = validSlice.reduce((acc, val) => acc + (val || 0), 0); smaValues.push(sum / period); } else { smaValues.push(NaN); } } } return { history: smaValues, latest: smaValues[smaValues.length - 1] || NaN }; }
        function calculateRSI(prices, period = 14) { if (!prices || prices.length < period + 1) return null; let changes = []; for (let i = 1; i < prices.length; i++) { if (typeof prices[i] === 'number' && typeof prices[i-1] === 'number') { changes.push(prices[i] - prices[i - 1]); } else { return null; } } if (changes.length < period) return null; let sumGain = 0; for (let i = 0; i < period; i++) { sumGain += Math.max(0, changes[i]); } let sumLoss = 0; for (let i = 0; i < period; i++) { sumLoss += Math.max(0, -changes[i]); } let avgGain = sumGain / period, avgLoss = sumLoss / period; for (let i = period; i < changes.length; i++) { avgGain = (avgGain * (period - 1) + Math.max(0, changes[i])) / period; avgLoss = (avgLoss * (period - 1) + Math.max(0, -changes[i])) / period; } if (avgLoss === 0) return 100; if (avgGain === 0) return 0; const RS = avgGain / avgLoss; const RSI = 100 - (100 / (1 + RS)); return isNaN(RSI) ? null : RSI; }
        function calculateEMA(prices, period) { if (!prices || prices.length < period) return null; const initialPrices = prices.slice(0, period); if (initialPrices.some(p => typeof p !== 'number')) return null; const multiplier = 2 / (period + 1); let emaValue = initialPrices.reduce((sum, price) => sum + price, 0) / period; for (let i = period; i < prices.length; i++) { if (typeof prices[i] !== 'number') return null; emaValue = (prices[i] - emaValue) * multiplier + emaValue; } return isNaN(emaValue) ? null : emaValue; }
        function calculateMACD(prices) { const fastPeriod = 12, slowPeriod = 26, signalPeriod = 9; if (!prices || prices.length < slowPeriod) return null; const fastEMASeries = [], slowEMASeries = []; let fastEma = calculateEMA(prices.slice(0, fastPeriod), fastPeriod); if (fastEma === null) return null; let slowEma = calculateEMA(prices.slice(0, slowPeriod), slowPeriod); if (slowEma === null) return null; const fastMultiplier = 2 / (fastPeriod + 1), slowMultiplier = 2 / (slowPeriod + 1); for (let i = 0; i < prices.length; i++) { if (typeof prices[i] !== 'number') return null; if (i >= fastPeriod -1) { fastEma = (i === fastPeriod - 1) ? calculateEMA(prices.slice(0, fastPeriod), fastPeriod) : (prices[i] - fastEma) * fastMultiplier + fastEma; fastEMASeries.push(fastEma); } else { fastEMASeries.push(NaN); } if (i >= slowPeriod - 1) { slowEma = (i === slowPeriod - 1) ? calculateEMA(prices.slice(0, slowPeriod), slowPeriod) : (prices[i] - slowEma) * slowMultiplier + slowEma; slowEMASeries.push(slowEma); } else { slowEMASeries.push(NaN); } } const macdLineHistory = []; for(let i = slowPeriod - 1; i < prices.length; i++){ if(!isNaN(fastEMASeries[i]) && !isNaN(slowEMASeries[i])){ macdLineHistory.push(fastEMASeries[i] - slowEMASeries[i]); } } if (macdLineHistory.length < signalPeriod) { return { macdLine: macdLineHistory.pop() || null, signalLine: null, histogram: null }; } const signalLine = calculateEMA(macdLineHistory, signalPeriod), latestMacdLine = macdLineHistory[macdLineHistory.length - 1]; if (signalLine === null || isNaN(latestMacdLine)) { return { macdLine: latestMacdLine, signalLine: null, histogram: null }; } const histogram = latestMacdLine - signalLine; if (isNaN(latestMacdLine) || isNaN(signalLine) || isNaN(histogram)) { return null; } return { macdLine: latestMacdLine, signalLine, histogram }; }
        function generateSignal(price, closingPricesUSD) { if (!closingPricesUSD || closingPricesUSD.length < 26) { return { signal: 'HOLD', strategy: `Gathering data (${closingPricesUSD ? closingPricesUSD.length : 0}/26 needed).`, icon: 'loader-2', rsi: 'N/A', macd: 'N/A', signalLine: 'N/A', histogram: 'N/A' }; } const ema12 = calculateEMA(closingPricesUSD, 12), ema26 = calculateEMA(closingPricesUSD, 26), rsi = calculateRSI(closingPricesUSD, 14), macdData = calculateMACD(closingPricesUSD); let signal = 'HOLD', strategy = 'Waiting for confirmation.', icon = 'pause', strength = ''; if (rsi === null || ema12 === null || ema26 === null || macdData === null || macdData.signalLine === null) { return { signal: 'HOLD', strategy: 'Indicator calculation error.', icon: 'alert-circle', rsi: rsi?.toFixed(2) || 'Err', macd: 'Err', signalLine: 'Err', histogram: 'Err' }; } const isMacdBullish = macdData.macdLine > macdData.signalLine, isMacdBearish = macdData.macdLine < macdData.signalLine, isRSIHealthyForBuy = rsi < 65, isRSIHealthyForSell = rsi > 35, isGoldenCross = ema12 > ema26, isDeathCross = ema12 < ema26; if (isMacdBullish && isGoldenCross && isRSIHealthyForBuy) { signal = 'BUY'; icon = 'zap'; strategy = 'MACD & Golden Cross alignment.'; strength = ' (High Conviction)'; } else if (isMacdBearish && isDeathCross && isRSIHealthyForSell) { signal = 'SELL'; icon = 'alert-triangle'; strategy = 'MACD & Death Cross alignment.'; strength = ' (High Conviction)'; } else if (isMacdBullish && isGoldenCross) { signal = 'BUY'; icon = 'zap'; strategy = 'MACD Bullish (Trend Confirmed).'; strength = ' (Mid Conviction - RSI High)'; } else if (isMacdBearish && isDeathCross) { signal = 'SELL'; icon = 'alert-triangle'; strategy = 'MACD Bearish (Trend Confirmed).'; strength = ' (Mid Conviction - RSI Low)'; } else if (isMacdBullish) { signal = 'HOLD'; icon = 'trending-up'; strategy = 'MACD Bullish Crossover (Momentum shift).'; strength = ' (Monitor Trend)'; } else if (isMacdBearish) { signal = 'HOLD'; icon = 'trending-down'; strategy = 'MACD Bearish Crossover (Momentum shift).'; strength = ' (Monitor Trend)'; } else { signal = 'HOLD'; icon = 'pause'; strategy = 'Consolidation/Low Momentum.'; } return { signal, strategy: strategy + strength, icon, rsi: rsi.toFixed(2), macd: macdData.macdLine.toFixed(4), signalLine: macdData.signalLine.toFixed(4), histogram: macdData.histogram.toFixed(4) }; }
        function renderChart(symbol, closingPricesUSD) { if (!closingPricesUSD || closingPricesUSD.length === 0) return; const minLengthForSMAs = 26; if (closingPricesUSD.length < minLengthForSMAs) return; const sma12Data = calculateSMAHistory(closingPricesUSD, 12), sma26Data = calculateSMAHistory(closingPricesUSD, 26); const ctx = document.getElementById(`chart-${symbol}`); if (!ctx) return; if (charts[symbol]) { charts[symbol].destroy(); } const labels = Array.from({length: closingPricesUSD.length}, (_, i) => i + 1); const chartData = closingPricesUSD.map(p => p * AED_RATE), sma12ChartData = sma12Data.history.map(p => isNaN(p) ? NaN : p * AED_RATE), sma26ChartData = sma26Data.history.map(p => isNaN(p) ? NaN : p * AED_RATE); const validStartIndex = sma26Data.history.findIndex(v => !isNaN(v)); const displayLabels = labels.slice(validStartIndex), displayChartData = chartData.slice(validStartIndex), displaySma12Data = sma12ChartData.slice(validStartIndex), displaySma26Data = sma26ChartData.slice(validStartIndex); charts[symbol] = new Chart(ctx, { type: 'line', data: { labels: displayLabels, datasets: [ { label: 'Price (AED)', data: displayChartData, borderColor: '#A855F7', backgroundColor: 'rgba(168, 85, 247, 0.1)', pointRadius: 0, borderWidth: 1.5, fill: false, tension: 0.1, yAxisID: 'y' }, { label: 'SMA 12', data: displaySma12Data, borderColor: '#34D399', pointRadius: 0, borderWidth: 1, fill: false, tension: 0.1, yAxisID: 'y' }, { label: 'SMA 26', data: displaySma26Data, borderColor: '#F87171', pointRadius: 0, borderWidth: 1, fill: false, tension: 0.1, yAxisID: 'y' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { x: { display: false }, y: { display: false, beginAtZero: false, suggestedMin: Math.min(...displayChartData.filter(v => !isNaN(v))) * 0.99, suggestedMax: Math.max(...displayChartData.filter(v => !isNaN(v))) * 1.01 } } } }); }

        // --- Data Fetching and Rendering ---
        async function fetchRealTimeData() {
            if (!DOM.marketDataContainer) return;
            const errorMsgElement = document.getElementById('fetch-error-msg');
            if (errorMsgElement) errorMsgElement.remove();
            const binanceSymbols = BASE_SYMBOLS.map(getBinanceSymbol);
            try {
                const symbolsParam = JSON.stringify(binanceSymbols);
                const priceUrl = `${BINANCE_API_BASE_URL}/api/v3/ticker/24hr?symbols=${encodeURIComponent(symbolsParam)}`;
                const priceDataArray = await fetchWithRetry(priceUrl);
                const priceDataMap = priceDataArray.reduce((map, item) => { map[item.symbol] = item; return map; }, {});

                const historicalPromises = BASE_SYMBOLS.map(baseSymbol => {
                    const binanceSymbol = getBinanceSymbol(baseSymbol);
                    const klineUrl = `${BINANCE_API_BASE_URL}/api/v3/klines?symbol=${binanceSymbol}&interval=${KLINE_INTERVAL}&limit=${KLINE_LIMIT}`;
                    return fetchWithRetry(klineUrl).catch(e => { console.error(`Kline fetch error for ${baseSymbol}:`, e.message); return []; });
                });
                const historicalResults = await Promise.all(historicalPromises);

                const newPrices = {}, newSignals = {};
                const loadingPlaceholder = document.getElementById('loading-placeholder');
                if (loadingPlaceholder) loadingPlaceholder.remove();

                BASE_SYMBOLS.forEach((symbol, index) => {
                     try {
                          const binanceSymbol = getBinanceSymbol(symbol); const item = priceDataMap[binanceSymbol]; const historicalKlines = historicalResults[index];
                          if (!item || !item.lastPrice || !historicalKlines || historicalKlines.length < 26) { throw new Error(`Incomplete/insufficient data`); } // Simplified error
                          const currentPriceUSD = parseFloat(item.lastPrice); const priceChangePercent = parseFloat(item.priceChangePercent) || 0; const closingPricesUSD = getClosingPrices(historicalKlines); const currentPriceAED = currentPriceUSD * AED_RATE;
                          newPrices[symbol] = currentPriceAED; let signalInfo = generateSignal(currentPriceUSD, closingPricesUSD); newSignals[symbol] = signalInfo.signal;
                          const cardElementId = `market-card-${symbol}`; let card = document.getElementById(cardElementId);
                          if (!card) { card = document.createElement('div'); card.id = cardElementId; card.className = "card p-4 border flex flex-col justify-between"; DOM.marketDataContainer.appendChild(card); card.innerHTML = ` <div class="flex items-center justify-between mb-3"><h3 class="text-xl font-bold">${symbol}</h3><div id="signal-${symbol}" class="px-3 py-1 text-xs font-semibold rounded-full shadow-md flex items-center"></div></div> <div class="flex flex-col mb-3"><p id="price-aed-${symbol}" class="text-2xl font-extrabold"></p><p id="price-usd-${symbol}" class="text-lg font-medium"></p><p id="change-percent-${symbol}" class="text-sm mt-1"></p></div> <div class="h-24 w-full mb-3 border rounded-md p-1"><canvas id="chart-${symbol}"></canvas></div> <div class="indicator-details space-y-1 text-sm pt-2 flex-grow border-t"></div> <div class="mt-2 pt-2 border-t"><p class="text-xs font-medium mb-1">My Thesis & Plan</p><div contenteditable="false" id="thesis-${symbol}" class="text-xs p-2 rounded-md min-h-[40px] focus:outline-none focus:ring-1 focus:ring-fuchsia-500 transition-colors" data-symbol="${symbol}"></div></div> `; }
                          updateMarketCardDetails(card, symbol, signalInfo, currentPriceAED, currentPriceUSD, priceChangePercent);
                          renderChart(symbol, closingPricesUSD);
                     } catch (coinError) {
                          console.error(`Error processing ${symbol}:`, coinError.message); newPrices[symbol] = 0; newSignals[symbol] = 'HOLD';
                          const cardElementId = `market-card-${symbol}`; let card = document.getElementById(cardElementId);
                          if (!card) { card = document.createElement('div'); card.id = cardElementId; card.className = "card p-4 border flex flex-col justify-center items-center"; DOM.marketDataContainer.appendChild(card); }
                          card.innerHTML = `<h3 class="text-xl font-bold">${symbol}</h3><p class="text-red-600 text-sm mt-2">Data Error</p><p class="text-xs">${coinError.message}</p>`; // Adjusted colors
                     }
                });
                livePrices = newPrices; signalData = newSignals; renderPortfolio();
                safeCreateIcons();

            } catch (error) {
                console.error("Critical Error fetching market data:", error.message);
                const loadingPlaceholder = document.getElementById('loading-placeholder'); if (loadingPlaceholder) loadingPlaceholder.remove();
                 if (DOM.marketDataContainer && !document.getElementById('fetch-error-msg')) {
                     const errorMsg = document.createElement('p'); errorMsg.id = 'fetch-error-msg'; errorMsg.className = 'col-span-full text-center text-red-600 py-4 font-semibold'; // Adjusted color
                     if (error.message.includes("429") || error.message.includes("418")) { errorMsg.textContent = 'Binance API rate limit hit. Wait 1 min & refresh.'; }
                     else if (error.name === 'AbortError') { errorMsg.textContent = 'Binance API timed out. Retrying...'; }
                     else if (error.message.includes("401")) { errorMsg.textContent = 'Binance API Error: Unauthorized (401).'; }
                     else if (error.message.includes("Failed to fetch")) { errorMsg.textContent = 'Network Error: Failed to connect to Binance API.'; }
                      else if (error.message.includes("400")) { errorMsg.textContent = 'Binance API Error: Bad Request (400). Check symbols?'; }
                     else { errorMsg.textContent = 'Failed to load market data from Binance. Check console.'; }
                     DOM.marketDataContainer.innerHTML = ''; DOM.marketDataContainer.appendChild(errorMsg);
                 }
            }
        }

        // --- updateMarketCardDetails ---
        function updateMarketCardDetails(cardElement, symbol, signalInfo, currentPriceAED, currentPriceUSD, priceChangePercent) {
            const signalDiv=cardElement.querySelector(`#signal-${symbol}`), priceAedP=cardElement.querySelector(`#price-aed-${symbol}`), priceUsdP=cardElement.querySelector(`#price-usd-${symbol}`), changePercentP=cardElement.querySelector(`#change-percent-${symbol}`), indicatorDetailsDiv=cardElement.querySelector('.indicator-details'), thesisDiv=cardElement.querySelector(`#thesis-${symbol}`);
            if(!signalDiv||!priceAedP||!priceUsdP||!changePercentP||!indicatorDetailsDiv||!thesisDiv){console.error(`Elements missing for ${symbol}.`); return;}
            const colorClass=signalInfo.signal==='BUY'?'signal-buy':signalInfo.signal==='SELL'?'signal-sell':'signal-hold'; signalDiv.className=`px-3 py-1 text-xs font-semibold rounded-full shadow-md ${colorClass} flex items-center`; signalDiv.innerHTML=`<i data-lucide="${signalInfo.icon}" class="w-4 h-4 mr-1"></i> ${signalInfo.signal.toUpperCase()}`;
            const priceClass=priceChangePercent>=0?'price-up':'price-down', sign=priceChangePercent>=0?'+':''; priceAedP.className=`text-2xl font-extrabold ${priceClass}`; priceAedP.innerHTML=`${currentPriceAED.toFixed(2)} <span class="text-sm font-normal text-slate-500">AED</span>`; priceUsdP.textContent=`$${currentPriceUSD.toFixed(2)} USDT`; priceUsdP.className=`text-lg font-medium text-slate-500`; changePercentP.className=`text-sm ${priceClass} mt-1`; changePercentP.textContent=`${sign}${priceChangePercent.toFixed(2)}% (24h)`;
            const macdHist=signalInfo.histogram!=='N/A'&&!isNaN(parseFloat(signalInfo.histogram))?parseFloat(signalInfo.histogram):0, macdHistClass=macdHist>=0?'macd-hist-up':'macd-hist-down'; indicatorDetailsDiv.innerHTML=`<p><span class="font-medium text-slate-700">Basis:</span> ${signalInfo.strategy}</p><p><span class="font-medium text-slate-700">RSI:</span> ${signalInfo.rsi}</p><p class="text-xs"><span class="font-medium text-slate-700">MACD:</span> ${signalInfo.macd}/${signalInfo.signalLine}<span class="font-bold ${macdHistClass}">[Hist:${signalInfo.histogram}]</span></p>`; indicatorDetailsDiv.className = `indicator-details space-y-1 text-sm text-slate-600 border-t pt-2 flex-grow`; // Adjusted text colors
            const savedThesis=userTheses[symbol]||'Click to set your plan...'; if(document.activeElement!==thesisDiv){thesisDiv.innerHTML=savedThesis;}
            const isOwner=auth.currentUser&&auth.currentUser.uid===OWNER_ID; thesisDiv.setAttribute('contenteditable',isOwner?'true':'false'); thesisDiv.className=`text-xs text-slate-700 p-2 rounded-md min-h-[40px] focus:outline-none focus:ring-1 focus:ring-fuchsia-500 transition-colors ${isOwner?'bg-slate-100 hover:bg-slate-200 border border-slate-300':'bg-slate-50 cursor-default border border-slate-200'}`; // Adjusted thesis box style
        }

        // --- renderPortfolio ---
        function renderPortfolio() {
            if (!isAuthReady || !DOM.holdingsList || !DOM.rebalanceSuggestionsEl || !DOM.totalInvestedAedEl || !DOM.totalValueAedEl || !DOM.totalValueUsdEl || !DOM.overallPnlEl) { return; }
            let totalInvestedAED = 0, totalValueAED = 0; DOM.holdingsList.innerHTML = '';
            if (investments.length === 0) { DOM.rebalanceSuggestionsEl.innerHTML = '<p class="text-center text-slate-500 py-2 text-sm">No investments.</p>'; DOM.holdingsList.innerHTML = '<p class="text-center text-slate-500 py-4">No investments added.</p>'; totalInvestedAED = 0; totalValueAED = 0; }
            else { investments.forEach(item => { const livePriceAED=livePrices[item.currency]||0, livePriceUSD=livePriceAED>0?livePriceAED/AED_RATE:0, purchasePriceAED=typeof item.purchasePriceAED==='number'?item.purchasePriceAED:0, quantity=typeof item.quantity==='number'?item.quantity:0; const investedAmount=quantity*purchasePriceAED, currentValue=quantity*livePriceAED, pnl=currentValue-investedAmount, pnlPercent=investedAmount>0?(pnl/investedAmount)*100:0; totalInvestedAED+=investedAmount; totalValueAED+=currentValue; const pnlClass=pnl>0?'status-profit':pnl<0?'status-loss':'status-zero'; let alertClass='', alertMessage=''; const stopLossAED=typeof item.stopLossAED==='number'?item.stopLossAED:null, takeProfitAED=typeof item.takeProfitAED==='number'?item.takeProfitAED:null; if(stopLossAED&&livePriceAED<=stopLossAED&&livePriceAED>0){alertClass='alert-sl'; alertMessage=`SL HIT @ ${livePriceAED.toFixed(2)}`;}else if(takeProfitAED&&livePriceAED>=takeProfitAED&&livePriceAED>0){alertClass='alert-tp'; alertMessage=`TP HIT @ ${livePriceAED.toFixed(2)}`;} const isOwner=auth.currentUser&&auth.currentUser.uid===OWNER_ID; const removeButton=isOwner?`<button onclick="window.removeInvestment('${item.id}')" class="ml-4 p-1 text-red-500 hover:text-red-700 rounded-full transition"><i data-lucide="x" class="w-4 h-4"></i></button>`:''; const holdingHtml=`<div id="holding-${item.id}" class="flex justify-between items-center p-3 rounded-lg border ${alertClass}"><div class="flex-1 min-w-0"><p class="text-lg font-bold">${item.currency}<span class="text-sm font-normal text-slate-500">(${(quantity||0).toFixed(4)})</span></p>${alertMessage?`<p class="text-xs font-semibold mt-1">${alertMessage} AED</p>`:''}<p class="text-xs text-slate-500 mt-1">Avg Buy: ${(purchasePriceAED||0).toFixed(2)}($${((purchasePriceAED||0)/AED_RATE).toFixed(2)})</p><p class="text-xs text-slate-500">Current: ${livePriceAED.toFixed(2)}($${livePriceUSD.toFixed(2)})</p>${(stopLossAED||takeProfitAED)?`<p class="text-xs text-slate-400">SL:${stopLossAED?stopLossAED.toFixed(2):'N/A'}|TP:${takeProfitAED?takeProfitAED.toFixed(2):'N/A'}</p>`:''}</div><div class="text-right ml-2 flex-shrink-0"><p class="text-base font-bold ${pnlClass}">${pnl.toFixed(2)}</p><p class="text-sm ${pnlClass}">(${pnlPercent.toFixed(2)}%)</p></div>${removeButton}</div>`; DOM.holdingsList.innerHTML += holdingHtml; }); } // Adjusted text colors
            const overallPNLValue = totalValueAED - totalInvestedAED, overallPNLPercent = totalInvestedAED > 0 ? (overallPNLValue / totalInvestedAED) * 100 : 0, overallPNLClass = overallPNLValue > 0 ? 'status-profit' : overallPNLValue < 0 ? 'status-loss' : 'status-zero'; DOM.totalInvestedAedEl.textContent = totalInvestedAED.toFixed(2); DOM.totalValueAedEl.textContent = totalValueAED.toFixed(2); DOM.totalValueUsdEl.textContent = totalValueAED > 0 ? (totalValueAED / AED_RATE).toFixed(2) : '0.00'; DOM.overallPnlEl.textContent = `${overallPNLValue.toFixed(2)} AED (${overallPNLPercent.toFixed(2)}%)`; DOM.overallPnlEl.className = `text-3xl font-extrabold ${overallPNLClass}`;
            calculateRebalanceSuggestions(totalValueAED);
            checkOwnerAccess();
            safeCreateIcons();
        }

        // --- calculateRebalanceSuggestions ---
        function calculateRebalanceSuggestions(totalValueAED) {
            if (!DOM.rebalanceSuggestionsEl) return; const suggestions = []; const availableInvestedCoins=Array.from(new Set(investments.map(i=>i.currency))).filter(c=>livePrices[c]!==undefined&&livePrices[c]>0); const totalInvestedWeight=availableInvestedCoins.length; if(totalInvestedWeight===0||totalValueAED===0){DOM.rebalanceSuggestionsEl.innerHTML='<p class="text-center text-slate-500 py-2 text-sm">No valid investments.</p>'; return;} const currentCoinValues={}; availableInvestedCoins.forEach(c=>{currentCoinValues[c]=0;}); investments.forEach(item=>{if(availableInvestedCoins.includes(item.currency)){currentCoinValues[item.currency]+=item.quantity*livePrices[item.currency];}}); const validTotalValueAED=availableInvestedCoins.reduce((sum,c)=>sum+currentCoinValues[c],0); if(validTotalValueAED===0){DOM.rebalanceSuggestionsEl.innerHTML='<p class="text-center text-slate-500 py-2 text-sm">Portfolio value is zero.</p>'; return;} const targetWeightPercent=100/totalInvestedWeight; for(const currency of availableInvestedCoins){const currentValue=currentCoinValues[currency], currentWeightPercent=(currentValue/validTotalValueAED)*100, driftPercent=currentWeightPercent-targetWeightPercent, signal=signalData[currency]||'HOLD'; const driftThreshold=Math.abs(driftPercent)>REBALANCE_THRESHOLD_PERCENT; if(driftThreshold){let requiredChangeAED=0, action='HOLD', reason=''; const targetValue=validTotalValueAED*(targetWeightPercent/100); requiredChangeAED=Math.abs(currentValue-targetValue); if(driftPercent>0){reason=`Overweight(${currentWeightPercent.toFixed(1)}% vs ${targetWeightPercent.toFixed(1)}%)`; if(signal==='SELL'){action='SELL'; reason+=' - Align SELL';}else if(signal==='BUY'){action='HOLD'; reason+=' - CONFLICT: Ignore (BUY)';}else{action='SELL'; reason+=' - Threshold';}}else{reason=`Underweight(${currentWeightPercent.toFixed(1)}% vs ${targetWeightPercent.toFixed(1)}%)`; if(signal==='BUY'){action='BUY'; reason+=' - Align BUY';}else if(signal==='SELL'){action='HOLD'; reason+=' - CONFLICT: Ignore (SELL)';}else{action='BUY'; reason+=' - Threshold';}} if(action!=='HOLD'){suggestions.push({currency, action, amountAED:requiredChangeAED, reason});}}} if(suggestions.length===0){DOM.rebalanceSuggestionsEl.innerHTML='<p class="text-center text-slate-500 py-2 text-sm">Balanced / Conflicted.</p>';} else {DOM.rebalanceSuggestionsEl.innerHTML=suggestions.map(s=>{const c=s.action==='BUY'?'rebalance-buy':'rebalance-sell', i=s.action==='BUY'?'trending-up':'trending-down'; return `<div class="p-3 rounded-lg ${c} flex justify-between items-center text-sm font-medium"><span class="flex items-center"><i data-lucide="${i}" class="w-4 h-4 mr-2"></i> ${s.action} ${s.amountAED.toFixed(2)} AED ${s.currency}</span><span class="text-xs ml-2">(${s.reason})</span></div>`;}).join('');} // Adjusted text colors
            safeCreateIcons();
        }

        // --- FIRESTORE OPERATIONS --- (Simplified, No color changes needed)
        function getCollectionRef() { if (!db) return null; const p=`artifacts/${firebaseConfig.appId}/portfolio_entries`; try {return firebase.collection(db,p);} catch(e){console.error("Collection ref error:",e);return null;} }
        async function getThesisDocRef() { if (!db) return null; const p=`artifacts/${firebaseConfig.appId}/config`; try {return firebase.doc(db,p,'thesis_data');} catch(e){console.error("Doc ref error:",e);return null;} }
        async function loadTheses() { const d=await getThesisDocRef(); if(!d)return; try {const s=await firebase.getDoc(d); if(s.exists()){userTheses=s.data().theses||{};}} catch(e){console.error("Load theses error:",e);} }
        window.saveThesis=async function(el){ if(!auth||!auth.currentUser)return;const o=auth.currentUser.uid===OWNER_ID;if(!o)return;const s=el.getAttribute('data-symbol'),c=el.textContent.trim(),p='Click to set your plan...'; const d=await getThesisDocRef(); if(!d){console.error("Thesis doc ref failed.");return;} if(c===p||c===''){try{await firebase.setDoc(d,{theses:{[s]:firebase.deleteField()}},{merge:true}); delete userTheses[s];}catch(e){console.error("Delete thesis error:",e);}}else{userTheses[s]=c; try{await firebase.setDoc(d,{theses:userTheses},{merge:true});}catch(e){console.error("Save thesis error:",e);}} }
        async function saveInvestment(ev){ ev.preventDefault(); if(!DOM.formStatusEl||!DOM.investmentForm)return; DOM.formStatusEl.textContent='Adding...'; const cE=DOM.investmentForm.querySelector('#currency'),qE=DOM.investmentForm.querySelector('#quantity'),pE=DOM.investmentForm.querySelector('#price'),tI=DOM.investmentForm.querySelector('#takeProfit'),sI=DOM.investmentForm.querySelector('#stopLoss'); if(!cE||!qE||!pE||!tI||!sI){DOM.formStatusEl.textContent='Form error.';return;} const c=cE.value,q=parseFloat(qE.value),p=parseFloat(pE.value),t=tI.value?parseFloat(tI.value):null,s=sI.value?parseFloat(sI.value):null; if(!c||isNaN(q)||isNaN(p)||q<=0||p<=0){DOM.formStatusEl.textContent='Invalid input.';return;} const r=getCollectionRef(); if(!r){DOM.formStatusEl.textContent='DB error.';return;} try{await firebase.addDoc(r,{currency:c,quantity:q,purchasePriceAED:p,takeProfitAED:t,stopLossAED:s,timestamp:firebase.Timestamp.fromDate(new Date())}); DOM.formStatusEl.textContent='Added!'; DOM.formStatusEl.className='text-center text-sm mt-2 text-green-600'; DOM.investmentForm.reset(); setTimeout(()=>{if(DOM.formStatusEl)DOM.formStatusEl.textContent='';},3000);}catch(e){DOM.formStatusEl.textContent='Save error.'; DOM.formStatusEl.className='text-center text-sm mt-2 text-red-600'; console.error("Add doc error:",e);} } // Added status colors
        window.removeInvestment=async function(id){ if(!auth||!auth.currentUser)return; const o=auth.currentUser.uid===OWNER_ID; if(!o)return; if(!db){console.error("DB not init.");return;} const d=firebase.doc(db,`artifacts/${firebaseConfig.appId}/portfolio_entries`,id); try{await firebase.deleteDoc(d);}catch(e){console.error("Remove doc error:",e);} }

        // --- AUTH & INIT ---
        function checkOwnerAccess() { if(!DOM.ownerAccessMessage||!DOM.investmentForm||!DOM.ownerLoginModal||!auth){return;} const o=auth.currentUser&&auth.currentUser.uid===OWNER_ID; DOM.ownerAccessMessage.classList.toggle('hidden',o); DOM.investmentForm.classList.toggle('hidden',!o); if(o&&DOM.ownerLoginModal){DOM.ownerLoginModal.classList.remove('flex'); DOM.ownerLoginModal.classList.add('hidden');} }
        function assignAndValidateDOMElements() { DOM.marketDataContainer=document.getElementById('market-data-container'); DOM.holdingsList=document.getElementById('holdings-list'); DOM.overallPnlEl=document.getElementById('overall-pnl'); DOM.totalInvestedAedEl=document.getElementById('total-invested-aed'); DOM.totalValueAedEl=document.getElementById('total-value-aed'); DOM.totalValueUsdEl=document.getElementById('total-value-usd'); DOM.formStatusEl=document.getElementById('form-status'); DOM.investmentForm=document.getElementById('investment-form'); DOM.ownerAccessMessage=document.getElementById('owner-access-message'); DOM.signInOwnerBtn=document.getElementById('sign-in-owner'); DOM.ownerLoginModal=document.getElementById('owner-login-modal'); DOM.ownerLoginForm=document.getElementById('owner-login-form'); DOM.loginStatusMessage=document.getElementById('login-status-message'); DOM.rebalanceSuggestionsEl=document.getElementById('rebalance-suggestions'); if(!DOM.marketDataContainer){console.error("CRITICAL DOM ERROR"); document.body.innerHTML='<div class="text-red-600 text-center p-8">Error loading UI.</div>'; return false;} return true; } // Adjusted color

        async function initializeFirebase() {
             if (!assignAndValidateDOMElements()) return;
            if (!firebaseConfig || !firebaseConfig.projectId) { console.error("Firebase config missing."); return; }
            try { const app = firebase.initializeApp(firebaseConfig); db = firebase.getFirestore(app); auth = firebase.getAuth(app); }
            catch (e) { console.error("Firebase Init Failed:", e); if (DOM.marketDataContainer) { DOM.marketDataContainer.innerHTML = '<p class="text-red-600 text-center p-4">Backend connection error.</p>'; } return; } // Adjusted color

            // Setup Event Listeners
            if (DOM.signInOwnerBtn) { DOM.signInOwnerBtn.addEventListener('click', () => { if (DOM.ownerLoginModal) { DOM.ownerLoginModal.classList.remove('hidden'); DOM.ownerLoginModal.classList.add('flex'); if (DOM.loginStatusMessage) DOM.loginStatusMessage.textContent = ''; } }); }
            if (DOM.ownerLoginForm) { DOM.ownerLoginForm.addEventListener('submit', async (e) => { e.preventDefault(); const eI=DOM.ownerLoginForm.querySelector('#owner-email'), pI=DOM.ownerLoginForm.querySelector('#owner-password'); if(!eI||!pI)return; const em=eI.value, pw=pI.value; if(DOM.loginStatusMessage)DOM.loginStatusMessage.textContent='Signing in...'; try { const uC=await firebase.signInWithEmailAndPassword(auth,em,pw); if(uC.user.uid===OWNER_ID){if(DOM.ownerLoginModal){DOM.ownerLoginModal.classList.remove('flex'); DOM.ownerLoginModal.classList.add('hidden');} checkOwnerAccess();} else {if(DOM.loginStatusMessage)DOM.loginStatusMessage.textContent='Not owner.'; await auth.signOut(); await firebase.signInAnonymously(auth);} } catch (error) {console.error("Owner Login Failed:",error); if(DOM.loginStatusMessage)DOM.loginStatusMessage.textContent=`Error: ${error.code||error.message}`; } }); }
            if (DOM.investmentForm) DOM.investmentForm.addEventListener('submit', saveInvestment);

            // Auth State Change Listener
            firebase.onAuthStateChanged(auth, async (user) => {
                 isAuthReady = true;
                 if (user) {
                      userId = user.uid; await loadTheses(); const cR=getCollectionRef();
                      if (cR) { firebase.onSnapshot(cR, (s) => { investments = s.docs.map(d => ({ id: d.id, ...d.data() })); renderPortfolio(); }, (e) => { console.error("Snapshot Error:", e); }); }
                      else { console.error("Failed portfolio ref."); renderPortfolio(); }
                 } else {
                      userId = null; investments = []; userTheses = {}; console.log("Signing in anonymously...");
                      try { const aU=await firebase.signInAnonymously(auth); userId = aU.user.uid; console.log("Anon UID:", userId); }
                      catch (e) { console.error("Anon sign-in failed:", e); if (DOM.marketDataContainer) { DOM.marketDataContainer.innerHTML = '<p class="text-red-600 text-center p-4">Auth failed. Refresh.</p>'; } } // Adjusted color
                       renderPortfolio();
                 }
                 checkOwnerAccess();
            });

            // Deferred Execution
            setTimeout(() => {
                 safeCreateIcons();
                 fetchRealTimeData();
                 setInterval(fetchRealTimeData, UPDATE_INTERVAL_MS);
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>

